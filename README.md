# 分析系统使用说明

## 系统概述

本系统是一个基于 PyQt5 的图像分析平台，旨在为用户提供两个主要功能模块：
- **镀膜褶皱趋势预测**：分析多张图片的褶皱趋势。
- **异常检测**：检测单张图片中的异常区域。

系统采用了现代化的界面设计，支持多模块切换，提供统一的用户体验。

## 界面介绍

### 主窗口布局

系统采用主窗口加导航栏的设计，包含以下区域：

#### 顶部导航栏
- **系统标题**：显示"分析系统"。
- **功能切换按钮**：
  - **镀膜褶皱趋势预测**（蓝色）。
  - **异常检测**（红色）。
- **菜单栏**：包含文件、工具、帮助等菜单选项。

#### 主工作区域
根据选择的功能模块动态切换界面内容。

#### 底部日志区域
- **系统日志**：实时显示系统运行状态和处理进度。

## 功能模块详解

### 1. 镀膜褶皱趋势预测模块

#### 左侧 - 图片上传区域
- **选择图片按钮**：支持多张图片选择（绿色按钮）。
- **图片列表**：显示已选择的图片，支持滚动查看。
- **清空列表按钮**：清除所有已选择的图片（红色按钮）。
- **开始处理按钮**：当图片数量≥15张时启用（蓝色按钮）。
- **进度条**：处理过程中显示进度。

#### 右侧 - 结果展示区域
- **处理结果展示**：显示预测结果图片。
- **刷新页面按钮**：清空当前状态（橙色按钮）。

#### 使用要求
- 至少需要15张图片才能开始处理。
- 支持jpg、jpeg、png、bmp、gif、tiff格式。

### 2. 异常检测模块

#### 左侧 - 图片上传区域
- **选择图片按钮**：选择单张图片（绿色按钮）。
- **图片信息显示**：显示当前选择的图片名称。
- **清空图片按钮**：清除当前选择的图片（红色按钮）。
- **开始处理按钮**：选择图片后启用（蓝色按钮）。
- **进度条**：处理过程中显示进度。

#### 在线批处理功能
- **启动在线批处理按钮**：启动文件夹监控批处理（紫色按钮）。
- **终止在线批处理按钮**：停止批处理（红色按钮）。
- **批处理状态显示**：实时显示批处理运行状态。
- **检查点管理**：支持检查点保存和恢复，避免重复处理。

#### 右侧 - 结果展示区域
- **标签页设计**：分别显示不同类型的结果。
  - **预测结果**：异常检测的预测图像。
  - **热力图**：异常区域的热力图可视化。
  - **JSON结果**：详细的检测结果数据。
- **刷新页面按钮**：清空当前状态（橙色按钮）。

#### 使用要求
- **单张图片处理**：只需选择1张图片。
- **批处理模式**：无需手动选择图片，自动监控指定文件夹。
- **图片格式**：支持jpg、jpeg、png、bmp、gif、tiff格式。

## 使用流程

### 启动系统
```bash
# 启动主窗口（推荐）
python main_window.py

# 独立启动各模块
python film_trend_analysis_tab.py  # 镀膜褶皱趋势预测
python anomaly_detection_tab.py    # 异常检测
```

### 功能切换
1. **导航按钮**：点击顶部导航栏的对应按钮。
2. **快捷键**：
   - `Ctrl+1`：切换到镀膜褶皱趋势预测。
   - `Ctrl+2`：切换到异常检测。
3. **菜单栏**：通过"工具"菜单选择功能。

### 镀膜褶皱趋势预测流程
1. **选择功能**：切换到镀膜褶皱趋势预测模块。
2. **上传图片**：点击"选择图片"，选择至少15张图片。
3. **开始处理**：点击"开始处理"按钮。
4. **查看结果**：在右侧查看预测结果图片。
5. **重新处理**：点击"刷新页面"清空状态。

### 异常检测流程
1. **选择功能**：切换到异常检测模块。
2. **上传图片**：点击"选择图片"，选择1张图片。
3. **开始处理**：点击"开始处理"按钮。
4. **查看结果**：在标签页中查看：
   - **预测结果**：异常检测的预测图像。
   - **热力图**：异常区域的热力图可视化。
   - **JSON结果**：详细的检测结果数据。
5. **重新处理**：点击"刷新页面"清空状态。

### 在线批处理异常检测流程
1. **选择功能**：切换到异常检测模块。
2. **配置环境变量**：确保`.env`文件中设置了`ONLINE_PROCESSING_AD_DIR`环境变量，指向要监控的文件夹。
3. **启动批处理**：点击"启动在线批处理"按钮。
4. **检查点选择**：
   - 如果存在之前的检查点文件，系统会弹出对话框让您选择：
     - **使用现有检查点**：继续处理未处理的图片
     - **创建新检查点**：从头开始处理所有图片
5. **自动监控**：系统会自动监控指定文件夹，处理新添加的图片。
6. **实时显示**：处理结果会实时显示在右侧标签页中。
7. **停止批处理**：点击"终止在线批处理"按钮停止监控。

## 在线批处理功能详解

### 检查点保存和恢复
- **自动保存**：系统每处理完一张图片后自动更新检查点文件
- **断点续传**：程序重启后可以选择继续处理未完成的图片
- **避免重复**：检查点记录已处理的图片，避免重复处理
- **时间戳管理**：检查点文件按时间戳命名，便于管理

### 批处理特性
- **文件夹监控**：自动监控指定文件夹中的新图片
- **轮询机制**：每5秒扫描一次文件夹
- **多线程处理**：批处理在后台线程运行，不影响界面响应
- **错误容错**：单张图片处理失败不影响其他图片处理
- **实时日志**：详细的处理进度和状态记录

### 检查点文件位置
检查点文件保存在：`temp/batch_processing_checkpoint/` 目录下
- 文件名格式：`YYYYMMDD_HHMMSS.json`
- 包含信息：已处理的图片路径列表、最后更新时间

## 技术特性

### 界面设计
- **现代化UI**：Material Design风格，统一的颜色方案。
- **响应式布局**：支持窗口大小调整。
- **多线程处理**：避免界面卡顿。
- **实时日志**：详细的处理过程记录。

### 功能特性
- **多模块集成**：统一的主窗口管理。
- **SSH远程处理**：通过SSH连接远程服务器。
- **自动文件管理**：临时文件自动清理。
- **错误处理**：完善的异常处理和用户提示。
- **进度显示**：实时进度条和状态更新。
- **在线批处理**：支持文件夹监控和自动处理。
- **检查点管理**：支持断点续传，避免重复处理。

### 按钮颜色规范
- **绿色**：主要操作（选择图片）。
- **红色**：危险操作（清空）。
- **蓝色**：核心功能（开始处理）。
- **橙色**：辅助功能（刷新页面）。
- **紫色**：批处理功能（启动在线批处理）。

## 环境配置

### 依赖安装
```bash
pip install -r requirements.txt
```

### SSH配置
确保 `.env` 文件包含正确的SSH连接信息：
- **SSH服务器地址和端口**：例如 `ssh.example.com:22`。
- **用户名和密码**：例如 `username` 和 `password`。
- **远程路径配置**：例如 `/path/to/remote/directory`。

### 在线批处理配置
在 `.env` 文件中添加：
- **ONLINE_PROCESSING_AD_DIR**：指定要监控的文件夹路径，例如 `C:/监控文件夹`

## 注意事项

### 使用限制
- **镀膜褶皱趋势预测**：需要至少15张图片才能开始处理。
- **异常检测**：只需1张图片。
- **处理过程中请勿关闭程序**：确保处理过程不被中断。
- **在线批处理**：需要配置`ONLINE_PROCESSING_AD_DIR`环境变量。

### 故障排除
- **查看底部日志区域**：了解详细的错误信息。
- **确保SSH连接配置正确**：检查 `.env` 文件中的配置。
- **检查网络连接状态**：确保网络连接稳定。
- **验证图片格式**：确保图片格式为jpg、jpeg、png、bmp、gif、tiff。
- **批处理文件夹权限**：确保监控文件夹存在且有读写权限。

### 性能优化
- **建议使用本地网络环境**：提高处理速度。
- **大图片处理可能需要较长时间**：耐心等待处理完成。
- **定期清理下载目录中的结果文件**：释放存储空间。
- **批处理检查点管理**：定期清理旧的检查点文件。

## 系统架构

```
analysis_system/
├── main_window.py              # 主窗口入口，负责整体界面管理和功能切换。
├── film_trend_analysis_tab.py  # 镀膜褶皱趋势预测模块，处理多张图片的褶皱趋势分析。
├── anomaly_detection_tab.py    # 异常检测模块，检测单张图片中的异常区域。
├── utils/                      # 工具模块，包含各种辅助功能。
│   ├── ssh_client_film_trend_analysis.py  # 用于镀膜褶皱趋势预测的SSH客户端。
│   ├── ssh_client_anomaly_detection.py    # 用于异常检测的SSH客户端。
│   └── file_namer.py                        # 文件命名工具。
├── download/                   # 结果下载目录，存放处理后的结果图片。
├── temp/                       # 临时文件目录，存放临时文件。
│   └── batch_processing_checkpoint/  # 批处理检查点文件目录
└── requirements.txt            # 依赖配置文件，列出所有需要的Python包。
```

## 更新日志

### v2.1 (最新)
- ✅ **在线批处理异常检测**：支持文件夹监控和自动处理
- ✅ **检查点保存和恢复**：支持断点续传，避免重复处理
- ✅ **检查点选择对话框**：支持选择现有检查点或创建新检查点
- ✅ **批处理状态实时显示**：实时显示批处理运行状态
- ✅ **错误容错机制**：单张图片处理失败不影响其他图片

### v2.0
- ✅ 整合主窗口设计
- ✅ 统一界面风格和用户体验
- ✅ 现代化按钮和容器样式
- ✅ 改进的导航和菜单系统
- ✅ 统一的日志显示区域

### v1.0
- ✅ 基础功能实现
- ✅ SSH远程处理
- ✅ 多线程处理架构
